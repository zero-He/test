"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();define(function(require,exports,module){function e(e){function t(t){t&&t.length&&(t.forEach(function(t){return t.resType=e}),n.resolve(t))}var n=a.Deferred();return 1==e?a(window).loadCoursewaRepository({type:"choseCW",data:{},callBack:t}):2==e?MicroWin.select(t):h.openPaper({},t),n}function t(e,t,n){var s=e[t];e[t]=function(){a.isFunction(s)&&s(),n()}}var n=require("common/react/react"),s=require("common/react/react-dom"),a=require("jquery"),r=require("json"),c=require("utils"),i=(require("dialog"),require("common/react/react-utils")),l=i.cx,o=require("common/base/date"),u=require("common/ui/ui-datepicker/ui-datepicker");require("common/ui/ui-scrollbar/jquery.scrollbar.min");var h=require("paper/web/leke.control.paper"),d={userMap:{},clone:function(e){return a.isArray(e)?e.map(function(e){return a.extend(!0,{},e)}):a.extend(!0,{},e)},getClasses:function(){var e=d.clone(classes);return e.forEach(function(e){return e.checked="false"}),e},fillUsers:function(e){var t=e.classId,n=a.Deferred();return null!=e.users?n.resolve(e):d[t]?(e.users=d[t].users,e.groups=d[t].groups,n.resolve(e)):a.post("/auth/teacher/assign/users.htm",{classId:t}).done(function(t){var s=t.datas.users,a=t.datas.groups;if(a.length>0){var r=s.map(function(e){return e.userId});a.forEach(function(e){return e.checked=!1}),a.unshift({groupId:0,groupName:"全班",checked:!1,userIds:r})}s.sort(function(e,t){return e.pinyin>t.pinyin?1:e.pinyin<t.pinyin?-1:0}),s.forEach(function(e){return e.checked=e.hidden=!1}),e.users=d.clone(s),e.groups=d.clone(a),n.resolve(e)}),n}},m=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){a(this.refs.scroll).scrollbar()}},{key:"render",value:function(){var e="scrollbar-inner "+this.props.className;return n.createElement("div",{ref:"scroll",className:e},this.props.children)}}]),t}(n.Component),p=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={checked:e.checked||!1},n}return _inherits(t,e),_createClass(t,[{key:"componentWillReceiveProps",value:function(e){this.props.checked!=e.checked&&this.setState({checked:e.checked})}},{key:"handleClick",value:function(e){this.props.onChange&&this.props.onChange(e)}},{key:"render",value:function(){var e=this.state.checked,t="c-assign-single-checkbox c-assign-single-checkbox-"+e;return n.createElement("span",{className:t,onClick:this.handleClick.bind(this)})}}]),t}(n.Component),f=(function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}_inherits(t,e),_createClass(t,[{key:"render",value:function(){n.createElement("div",null,n.createElement("label",null,n.createElement("input",{type:"radio",name:"exam-time"}),"60分钟"),n.createElement("label",null,n.createElement("input",{type:"radio",name:"exam-time",checked:!0}),"90分钟"),n.createElement("label",null,n.createElement("input",{type:"radio",name:"exam-time"}),"120分钟"))}}]),t}(n.Component),function(e){function s(e){_classCallCheck(this,s);var t=_possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e));return t.handleClick=t.handleClick.bind(t),t.handleChange=t.handleChange.bind(t),t.state={value:e.value,options:t.parseOptions(e.setting)},t}return _inherits(s,e),_createClass(s,[{key:"parseOptions",value:function(e){var n=a.extend({readOnly:!0},e);return t(n,"onpicked",this.handleChange),t(n,"oncleared",this.handleChange),n}},{key:"handleClick",value:function(e){u.open(e.nativeEvent,this.state.options)}},{key:"getValue",value:function(){return this.refs.picket.value}},{key:"handleChange",value:function(){var e=this.refs.picket.value;this.setState({value:e}),this.props.onChange&&this.props.onChange(e)}},{key:"render",value:function(){return n.createElement("input",{ref:"picket",id:this.props.id,type:"text",className:l(this.props.className,"Wdate"),defaultValue:this.props.defaultValue,placeholder:this.props.placeholder,onClick:this.handleClick})}}]),s}(n.Component)),g=function(t){function s(e){_classCallCheck(this,s);var t=_possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e));return t.state={datas:e.section.resources},t}return _inherits(s,t),_createClass(s,[{key:"handleSelect",value:function(t){var n=this;e(t).done(function(e){var t=n.props.section.resources;if(e=e.filter(function(e){return 0==t.filter(function(t){return t.type===e.type&&t.resId===e.resId}).length}),e.length>0){var s=t.concat(e);n.props.section.resources=s,n.setState({datas:s})}})}},{key:"handleRemove",value:function(e,t,n){var s=this.props.section.resources;s=s.filter(function(t){return!(t.resType==e.resType&&t.resId==e.resId)}),this.props.section.resources=s,this.setState({datas:s})}},{key:"render",value:function(){var e=this,t=this,s=this.props,a=s.showRemove,r=s.onRemove,c=this.props.section.resources;return n.createElement("div",{className:"c-assign-single-header c-assign-work-collection"},n.createElement("div",{className:"c-assign-single-hwc c-assign-single-left"},n.createElement("label",{className:"c-assign-single-lh"},n.createElement("span",{className:"work-quick-check paper"},"试卷："),n.createElement("button",{className:"u-btn u-btn-sm u-btn-bg-orange c-assign-single-choose",onClick:this.handleSelect.bind(this,3)},"请选择")),n.createElement("div",{className:"c-assign-work"},c.filter(function(e){return 3==e.resType}).map(function(s){return n.createElement("span",{key:s.resId,className:"c-assign-work-item"},n.createElement("b",{title:s.resName},s.resName),n.createElement("i",{onClick:t.handleRemove.bind(t,s,e.props)},"×"))}))),a?n.createElement("span",{className:"c-assign-single-delete",onClick:function(){return r()}}):null)}}]),s}(n.Component),k=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={classes:d.getClasses(),clazz:null},e.section.classes=n.state.classes,n}return _inherits(t,e),_createClass(t,[{key:"handleClickClass",value:function(e,t,n,s){d.fillUsers(e).done(function(e){s&&(0==e.users.length?e.checked="false":"true"==e.checked?(e.groups.length>0&&(e.groups[0].checked=!0,e.groups.slice(1).forEach(function(e){return e.checked=!1})),e.users.forEach(function(e){return e.checked=!0}),e.users.forEach(function(e){return e.hidden=!1})):"false"==e.checked&&(e.groups.forEach(function(e){return e.checked=!1}),e.users.forEach(function(e){return e.checked=e.hidden=!1}))),this.setState({clazz:e})}.bind(this))}},{key:"handleSelectClass",value:function(e,t,n){n.stopPropagation(),"half"==e.checked||"false"==e.checked?e.checked="true":e.checked="false",this.handleClickClass(e,t,n,!0)}},{key:"handleSelectGroup",value:function(e,t){e.checked=!e.checked;var n=this.state.clazz;if(0===e.groupId)e.checked?(n.groups.slice(1).forEach(function(e){return e.checked=!1}),n.users.forEach(function(e){return e.checked=!0})):n.users.forEach(function(e){return e.checked=!1}),n.users.forEach(function(e){return e.hidden=!1});else if(e.checked){var s={};n.groups[0].checked=!1,e.userIds.forEach(function(e){return s[e]=!0});var a=0===n.groups.filter(function(t){return t.groupId!=e.groupId&&t.checked}).length;a?n.users.forEach(function(e){var t=s[e.userId];e.checked=t,e.hidden=!t}):n.users.forEach(function(e){s[e.userId]&&(e.checked=!0,e.hidden=!1)})}else if(n.groups.some(function(e){return e.checked})){var s={};e.userIds.forEach(function(e){return s[e]=!0}),n.groups.slice(1).filter(function(e){return e.checked}).forEach(function(e){e.userIds.forEach(function(e){delete s[e]})}),n.users.forEach(function(e){s[e.userId]&&(e.checked=!1,e.hidden=!0)})}else n.users.forEach(function(e){e.checked=e.hidden=!1});this.syncClassCheckStatus(n),this.setState({clazz:n})}},{key:"handleSelectUser",value:function(e,t){var n=this.state.clazz;e.checked=!e.checked,this.syncClassCheckStatus(n),this.setState({clazz:this.state.clazz})}},{key:"syncClassCheckStatus",value:function(e){e.users.every(function(e){return 1==e.checked})?e.checked="true":e.users.every(function(e){return 1!=e.checked})?e.checked="false":e.checked="half"}},{key:"componentDidUpdate",value:function(){var e=this.refs,t=e.groups;e.users.style.paddingTop=t.offsetHeight+"px"}},{key:"render",value:function(){var e=this,t=[],s=[],a=0;this.state.clazz&&(t=this.state.clazz.users||t,s=this.state.clazz.groups||s,a=this.state.clazz.classId),t=t.filter(function(e){return e.hidden!==!0});var r=["c-assign-xing-icon","c-assign-xuan-icon","c-assign-fen-icon","c-assign-fen-icon"];return n.createElement("div",{className:"c-assign-single c-assign-single-main"},n.createElement("div",{className:"c-assign-single-body"},n.createElement(m,{className:"c-assign-single-classes"},n.createElement("ul",{className:"c-assign-class-container"},this.state.classes.map(function(t,s){return n.createElement("li",{className:l("c-assign-single-class",{"c-assign-single-checked":t.classId==a}),key:t.classId,onClick:e.handleClickClass.bind(e,t,s)},n.createElement(p,{checked:t.checked,onChange:e.handleSelectClass.bind(e,t,s)}),n.createElement("span",{className:r[t.classType-1]}),n.createElement("span",{className:"c-assign-single-name",title:t.className},t.className))}))),n.createElement(m,{className:"c-assign-single-stu"},n.createElement("div",{className:"c-detail-container"},n.createElement("div",{ref:"groups",className:"groups"},s.map(function(t,s){return n.createElement("span",{key:t.groupId,className:"item",title:t.groupName,onClick:e.handleSelectGroup.bind(e,t,s)},n.createElement(p,{checked:t.checked}),n.createElement("span",{style:{paddingLeft:4}},t.groupName))})),n.createElement("div",{ref:"users"},t.map(function(t,s){return n.createElement("span",{key:t.userId,className:"item",title:t.userName,onClick:e.handleSelectUser.bind(e,t,s)},n.createElement(p,{checked:t.checked}),n.createElement("span",{style:{paddingLeft:4}},t.userName))}),null!=e.state.clazz&&0==t.length?n.createElement("div",{className:"m-tips"},n.createElement("i",null),n.createElement("span",null,"该班级没有学生，请核实后再布置")):null),null==e.state.clazz?n.createElement("div",{className:"m-tips"},n.createElement("i",null),n.createElement("span",null,"请在左侧选择要考试的班级")):null))))}}]),t}(n.Component),y=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this.props,t=e.section,s=e.showRemove,a=e.onRemove;return n.createElement("div",null,n.createElement("div",{className:"c-assign-h3"},n.createElement("h3",null,"选择试卷")),n.createElement(g,{section:t,showRemove:s,onRemove:a}),n.createElement("div",{className:"c-assign-h3"},n.createElement("h3",null,"选择学生")),n.createElement(k,{section:t}))}}]),t}(n.Component),v=1001,C=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={isOpenAnswer:!1,openAnswerTime:"",startTime:o.format(Leke.Clock.time(),"yyyy-MM-dd HH:mm"),closeTime:"",diffTime:"90",sections:[{key:v++,resources:resources||[]}],pending:!1},n.handleSaveAssign=n.handleSaveAssign.bind(n),n.handleChangeOpenAnswer=n.handleChangeOpenAnswer.bind(n),n.handleChangeStartTime=n.handleChangeStartTime.bind(n),n.handleChangeExamTime=n.handleChangeExamTime.bind(n),n.handleChangeOpenAnswerTime=n.handleChangeOpenAnswerTime.bind(n),n}return _inherits(t,e),_createClass(t,[{key:"handleChangeOpenAnswer",value:function(){var e=this.state,t=e.isOpenAnswer,n=(e.openAnswerTime,e.startTime);t?this.setState({isOpenAnswer:!1,openAnswerTime:""}):this.setState({isOpenAnswer:!0,openAnswerTime:o.of(n).add(2,"d").format("yyyy-MM-dd HH:mm")})}},{key:"handleChangeExamTime",value:function(e){var t=this.state,n=t.startTime;t.closeTime,t.diffTime;this.setState({diffTime:e.currentTarget.defaultValue,closeTime:o.of(n).add(e.currentTarget.defaultValue,"m").format("yyyy-MM-dd HH:mm")})}},{key:"handleChangeOpenAnswerTime",value:function(e){this.state.openAnswerTime;this.setState({openAnswerTime:e})}},{key:"handleChangeStartTime",value:function(e){var t=this.state,n=(t.startTime,t.closeTime,t.diffTime);this.setState({startTime:e,closeTime:o.of(e).add(n,"m").format("yyyy-MM-dd HH:mm")})}},{key:"handleDelSection",value:function(e){if(this.state.sections.length<=1)return void c.Notice.alert("最后一个啦");var t=a.grep(this.state.sections,function(t,n){return t.id!=e});this.setState({sections:t})}},{key:"handleSaveAssign",value:function(){for(var e=this.state,t=e.startTime,n=e.closeTime,s=e.isOpenAnswer,i=e.openAnswerTime,l=this.state.sections.map(function(e){return{resources:e.resources,classes:e.classes.filter(function(e){return"false"!==e.checked}).map(function(e){var t={classId:e.classId,className:e.className,classType:e.classType};return t.groups=e.groups.filter(function(e){return e.checked&&0!==e.groupId}).map(function(e){return{groupId:e.groupId,groupName:e.groupName}}),t.users=e.users.filter(function(e){return!e.hidden&&e.checked}).map(function(e){return{userId:e.userId,userName:e.userName}}),t})}}),u=0;u<l.length;u++){var h=l[u];if(0==h.resources.length)return void c.Notice.alert("请选择试卷");if(0==h.classes.length)return void c.Notice.alert("请选择班级")}if(""==t)return void c.Notice.alert("请设置试卷开始时间");if(""==n&&(n=o.of(t).add(90,"m").format("yyyy-MM-dd HH:mm")),s&&""==i)return void c.Notice.alert("请设置公布答案时间");if((new Date).getTime()>=o.parse(t,"yyyy-MM-dd HH:mm").getTime())return void c.Notice.alert("请重新选择考试开始时间!");var d={startTime:o.parse(t,"yyyy-MM-dd HH:mm").getTime(),closeTime:o.parse(n,"yyyy-MM-dd HH:mm").getTime(),openAnswerTime:""==i?"":o.parse(i,"yyyy-MM-dd HH:mm").getTime(),sections:l};this.setState({pending:!0}),a.post("/auth/teacher/exam/assign/saveAssign.htm",{dataJson:r.stringify(d)}).done(function(e){if(e.success){var t="/auth/teacher/exam/assign/success.htm";e.datas.homeworkId&&(t+="?homeworkId="+e.datas.homeworkId),window.location.href=t}else this.setState({pending:!1})}.bind(this))}},{key:"render",value:function(){var e=this,t=this.state.sections.length>1,s=l("u-btn u-btn-lg",this.state.pending?"u-btn-bg-gray":"u-btn-bg-turquoise");return n.createElement("div",null,n.createElement("div",{className:"m-assgin-tab"},n.createElement("ul",null,n.createElement("li",{className:"assgin-tab-header"},"发布考试"))),this.state.sections.map(function(s,a){return n.createElement(y,{key:s.id+"",section:s,showRemove:t,onRemove:e.handleDelSection.bind(e,s.id)})}),n.createElement("div",{className:"c-assign-h3"},n.createElement("h3",null,"选择考试时间")),n.createElement("div",{className:"c-assign-date z-clear c-assign-bottom-date"},n.createElement("div",{className:"c-assign-picker"},n.createElement(f,{id:"startTime",className:"u-ipt u-ipt-nm c-assign-date-container",setting:{dateFmt:"yyyy-MM-dd HH:mm"},placeholder:"试卷开始时间",defaultValue:this.state.startTime,onChange:this.handleChangeStartTime}),n.createElement("p",{className:"z-tips"},"考试开始时间")),n.createElement("div",{className:"exam-duration"},n.createElement("span",null,"考试时长："),n.createElement("label",null,n.createElement("input",{type:"radio",name:"exam-time",onChange:this.handleChangeExamTime,defaultValue:60}),"60分钟"),n.createElement("label",null,n.createElement("input",{type:"radio",name:"exam-time",onChange:this.handleChangeExamTime,defaultValue:90,defaultChecked:!0}),"90分钟"),n.createElement("label",null,n.createElement("input",{type:"radio",name:"exam-time",onChange:this.handleChangeExamTime,defaultValue:120}),"120分钟")),n.createElement("div",{className:"c-assign-picker c-assign-publish-picker"},n.createElement(p,{checked:this.state.isOpenAnswer,onChange:this.handleChangeOpenAnswer}),n.createElement("span",{className:"z-inline-zips"},n.createElement("span",{onClick:this.handleChangeOpenAnswer},"设置公布答案时间")),this.state.isOpenAnswer?n.createElement(f,{id:"openAnswerTime",className:"u-ipt u-ipt-nm c-assign-date-container",setting:{dateFmt:"yyyy-MM-dd HH:mm"},placeholder:"公布答案时间",defaultValue:this.state.openAnswerTime,onChange:this.handleChangeOpenAnswerTime}):null,n.createElement("p",{className:"z-tips"}))),n.createElement("div",{className:"c-assign-plus m-tiptext m-tiptext-text m-tiptext-warning"},n.createElement("i",{className:"iconfont icon"},"󰅂 "),n.createElement("span",null,"学生仅能在平板端进行线上考试。")),n.createElement("div",{className:"z-sub-btn"},n.createElement("button",{className:s,onClick:this.handleSaveAssign,disabled:this.state.pending},this.state.pending?"处理中...":"发布")))}}]),t}(n.Component);s.render(n.createElement(C,null),document.getElementById("container"))});