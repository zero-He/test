"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();define(function(require,exports,module){var e=require("common/react/react"),t=require("common/react/react-dom"),n=require("common/react/react-utils"),o=(n.cx,require("./imgview")),a=require("jquery"),i=require("underscore"),s=require("utils"),r=require("dialog"),l=require("common/convertions"),c=e.Component,u=(e.PropTypes,function(t){function n(){return _classCallCheck(this,n),_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return _inherits(n,t),_createClass(n,[{key:"render",value:function(){return e.createElement("div",{className:"student"},e.createElement("i",{className:"icon-student"}),e.createElement("span",null,"学生：",this.props.children))}}]),n}(c)),d=function(t){function n(){return _classCallCheck(this,n),_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return _inherits(n,t),_createClass(n,[{key:"render",value:function(){return e.createElement("div",{className:"reason"},e.createElement("i",{className:"icon-reason"}),e.createElement("span",null,"异常原因：",this.props.children))}}]),n}(c),h=function(t){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.handleDelPage=t.handleDelPage.bind(t),t.handlePosition=t.handlePosition.bind(t),t}return _inherits(n,t),_createClass(n,[{key:"handleDelPage",value:function(){this.props.onDelPage&&this.props.onDelPage(this.props.pageId)}},{key:"handlePosition",value:function(){this.props.onPosition&&this.props.onPosition(this.props.path)}},{key:"render",value:function(){var t=this.props,n=t.path,o=t.index,a=t.deleted,i=l.toCnNum(o),s=[];return a&&s.push(e.createElement("i",{className:"del",onClick:this.handleDelPage})),e.createElement("li",null,e.createElement("div",{className:"figure"},e.createElement("img",{src:n,width:"132",onClick:this.handlePosition}),s),e.createElement("h5",null,i))}}]),n}(c),m=function(t){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.state={bookId:e.bookId,pages:[],imgs:[],imgIndex:0,userName:""},t.fillCurrBook(e.bookId),t.handleJump=t.handleJump.bind(t),t.handleSave=t.handleSave.bind(t),t.handleDelPage=t.handleDelPage.bind(t),t.handlePosition=t.handlePosition.bind(t),t}return _inherits(n,t),_createClass(n,[{key:"fillCurrBook",value:function(e){a.post("get.htm",{bookId:e}).done(function(e){e.success&&this.setState(e.datas)}.bind(this))}},{key:"doNextBook",value:function(e){e?this.fillCurrBook(e):r.alert("已经是最后一个").done(function(){window.close()})}},{key:"handleJump",value:function(){var e=this.state.bookId;a.post("next.htm",{bookId:e}).done(function(e){this.doNextBook(e.datas.nextBookId)}.bind(this))}},{key:"handleSave",value:function(){var e=this.state,t=e.bookId,n=e.pages,o=i.countBy(n,"index");for(var r in o)if(o[r]>1)return void s.Notice.alert("还有重页没有删除呢");var l=n.map(function(e){return e.pageId}),c=JSON.stringify({bookId:t,pageIds:l});a.post("save.htm",{dataJson:c}).done(function(e){e.success&&this.doNextBook(e.datas.nextBookId)}.bind(this))}},{key:"handlePosition",value:function(e){var t=this.state.imgs,n=i.indexOf(t,e);this.setState({imgIndex:n})}},{key:"handleDelPage",value:function(e){var t=this.state.pages,n=[];t.forEach(function(t){t.pageId!==e&&n.push(t)});var o=i.flatten(n.map(function(e){return e.imgs}));this.setState({pages:n,imgs:o,imgIndex:0})}},{key:"render",value:function(){var t=this,n=this.state,a=n.pages,s=n.userName,r=n.imgs,l=n.imgIndex,c=i.countBy(a,"index");return e.createElement("div",null,e.createElement("div",{className:"c-sheet-show"},e.createElement(o,{imgs:r,index:l})),e.createElement("div",{className:"c-sheet-operation"},e.createElement("h5",{className:"head"},"异常处理"),e.createElement("div",{className:"con"},e.createElement(u,null,s),e.createElement(d,null,"重页异常"),e.createElement("div",{className:"c-abnormal-page"},e.createElement("ul",{className:"num"},a.map(function(n){return e.createElement(h,{pageId:n.pageId,index:n.index,path:n.imgs[0],deleted:c[n.index]>1,onDelPage:t.handleDelPage,onPosition:t.handlePosition})}))),e.createElement("div",{className:"btns"},e.createElement("button",{className:"u-btn u-btn-nm u-btn-bg-turquoise",onClick:this.handleSave},"提交"),e.createElement("button",{className:"u-btn u-btn-nm u-btn-bg-gray",onClick:this.handleJump},"暂不处理")))))}}]),n}(c);t.render(e.createElement(m,{bookId:firstBookId}),document.getElementById("container"))});