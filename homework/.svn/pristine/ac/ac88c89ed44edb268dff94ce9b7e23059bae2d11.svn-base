"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();define(function(require,exports,module){function e(){var e=c.Deferred();return l.open({title:"确认分组",tpl:'<div style="font-size:16px;text-align:center;padding-top:20px;">您已经完成分组了吗？</div><div style="font-size:12px;text-align:center;color:#999;padding-top:10px;">是：已完成分组，否：暂不使用分组。</div>',size:"mini",onClose:function(t){e.resolve(t)},btns:[{className:"btn-green",text:"是",cb:function(){this.close(!0)}},{className:"btn-gray",text:"否",cb:function(){this.close(!1)}}]}),e}function t(e){function t(t){t&&t.length&&(t.forEach(function(t){return t.resType=e}),n.resolve(t))}var n=c.Deferred();return f.loadHistory().done(function(n){1==e?p.openCouSelect({datas:n,onSelect:t}):2==e?p.openMicSelect({datas:n,onSelect:t}):m.openPaper({data:n},t)}),n}function n(e,t,n){var s=e[t];e[t]=function(){c.isFunction(s)&&s(),n()}}var s=require("common/react/react"),a=require("common/react/react-dom"),c=require("jquery"),r=require("json"),i=require("utils"),l=require("dialog"),o=require("common/react/react-utils"),u=o.cx,d=require("common/base/date"),h=require("common/ui/ui-datepicker/ui-datepicker"),m=require("paper/web/leke.control.paper"),p=require("repository/select/p-repo-select"),f=require("repository/service/HistoryService");require("common/ui/ui-scrollbar/jquery.scrollbar.min");var g={userMap:{},clone:function(e){return c.isArray(e)?e.map(function(e){return c.extend(!0,{},e)}):c.extend(!0,{},e)},getClasses:function(){var e=g.clone(classes);return e.forEach(function(e){return e.checked="false"}),e},fetchUsers:function(e,t){var n=c.Deferred();return 1!=t&&g[e]?n.resolve(g[e]):c.post("users.htm",{classId:e}).done(function(t){var s=t.datas.users,a=t.datas.groups;if(a.length>0){var c=s.map(function(e){return e.userId});a.forEach(function(e){return e.checked=!1}),a.unshift({groupId:0,groupName:"全班",checked:!1,userIds:c})}s.sort(function(e,t){return e.pinyin>t.pinyin?1:e.pinyin<t.pinyin?-1:0}),s.forEach(function(e){return e.checked=e.hidden=!1}),g[e]=t.datas,n.resolve(t.datas)}),n},fillUsers:function(e){var t=e.classId,n=c.Deferred();return null!=e.users?n.resolve(e):g.fetchUsers(t).done(function(t){e.users=g.clone(t.users),e.groups=g.clone(t.groups),n.resolve(e)}),n}},k=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){c(this.refs.scroll).scrollbar()}},{key:"render",value:function(){var e="scrollbar-inner "+this.props.className;return s.createElement("div",{ref:"scroll",className:e},this.props.children)}}]),t}(s.Component),v=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={checked:e.checked||!1},n}return _inherits(t,e),_createClass(t,[{key:"componentWillReceiveProps",value:function(e){this.props.checked!=e.checked&&this.setState({checked:e.checked})}},{key:"handleClick",value:function(e){this.props.onChange&&this.props.onChange(e)}},{key:"render",value:function(){var e=this.state.checked,t="c-assign-single-checkbox c-assign-single-checkbox-"+e;return s.createElement("span",{className:t,onClick:this.handleClick.bind(this)})}}]),t}(s.Component),y=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.handleClick=n.handleClick.bind(n),n.handleChange=n.handleChange.bind(n),n.state={value:e.value,options:n.parseOptions(e.setting)},n}return _inherits(t,e),_createClass(t,[{key:"parseOptions",value:function(e){var t=c.extend({readOnly:!0},e);return n(t,"onpicked",this.handleChange),n(t,"oncleared",this.handleChange),t}},{key:"handleClick",value:function(e){h.open(e.nativeEvent,this.state.options)}},{key:"getValue",value:function(){return this.refs.picket.value}},{key:"handleChange",value:function(){var e=this.refs.picket.value;this.setState({value:e}),this.props.onChange&&this.props.onChange(e)}},{key:"render",value:function(){return s.createElement("input",{ref:"picket",id:this.props.id,type:"text",className:u(this.props.className,"Wdate"),defaultValue:this.props.defaultValue,placeholder:this.props.placeholder,onClick:this.handleClick})}}]),t}(s.Component),C=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.state={datas:e.section.resources},t}return _inherits(n,e),_createClass(n,[{key:"handleSelect",value:function(e){var n=this;t(e).done(function(e){var t=n.props.section.resources;if(e=e.filter(function(e){return 0==t.filter(function(t){return t.type===e.type&&t.resId===e.resId}).length}),e.length>0){var s=t.concat(e);n.props.section.resources=s,n.setState({datas:s})}})}},{key:"handleRemove",value:function(e,t){var n=this.props.section.resources;n=n.filter(function(t){return!(t.resType==e.resType&&t.resId==e.resId)}),this.props.section.resources=n,this.setState({datas:n})}},{key:"render",value:function(){var e=this,t=this.props,n=t.showRemove,a=t.onRemove,c=this.props.section.resources,r=c.filter(function(e){return 1==e.resType}),i=c.filter(function(e){return 2==e.resType}),l=c.filter(function(e){return 3==e.resType});return s.createElement("div",{className:"c-assign-single-header c-assign-work-collection"},s.createElement("div",{className:"c-assign-single-sc c-assign-single-left"+(0==l.length?" c-assign-single-null":"")},s.createElement("label",{className:"c-assign-single-lh"},s.createElement("span",{className:"work-quick-check paper"},s.createElement("button",{className:"u-btn c-assign-single-choose",onClick:this.handleSelect.bind(this,3)}),s.createElement("span",null,"添加试卷"))),s.createElement("div",{className:"c-assign-work"},l.map(function(t){return s.createElement("span",{key:t.resId,className:"c-assign-work-item"},s.createElement("b",{title:t.resName},t.resName),s.createElement("i",{onClick:e.handleRemove.bind(e,t)},"×"))}))),s.createElement("div",{className:"c-assign-single-sc c-assign-single-left"+(0==r.length?" c-assign-single-null":"")},s.createElement("label",{className:"c-assign-single-lh"},s.createElement("span",{className:"work-quick-check courseware"},s.createElement("button",{className:"u-btn c-assign-single-choose",onClick:this.handleSelect.bind(this,1)}),s.createElement("span",null,"添加课件"))),s.createElement("div",{className:"c-assign-work"},r.map(function(t){return s.createElement("span",{key:t.resId,className:"c-assign-work-item"},s.createElement("b",{title:t.resName},t.resName),s.createElement("i",{onClick:e.handleRemove.bind(e,t)},"×"))}))),s.createElement("div",{className:"c-assign-single-sc c-assign-single-left"+(0==i.length?" c-assign-single-null":"")},s.createElement("label",{className:"c-assign-single-lh"},s.createElement("span",{className:"work-quick-check tiny"},s.createElement("button",{className:"u-btn c-assign-single-choose",onClick:this.handleSelect.bind(this,2)}),s.createElement("span",null,"添加微课"))),s.createElement("div",{className:"c-assign-work"},i.map(function(t){return s.createElement("span",{key:t.resId,className:"c-assign-work-item"},s.createElement("b",{title:t.resName},t.resName),s.createElement("i",{onClick:e.handleRemove.bind(e,t)},"×"))}))),n?s.createElement("span",{className:"c-assign-single-delete",onClick:function(){return a()}}):null)}}]),n}(s.Component),E=function(t){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.state={keyword:"",classes:g.getClasses(),clazz:null},e.section.classes=t.state.classes,t}return _inherits(n,t),_createClass(n,[{key:"handleChangeKeyword",value:function(e){this.setState({keyword:c.trim(e.target.value)})}},{key:"handleDeleteKeyword",value:function(e){this.setState({keyword:""})}},{key:"handleClickClass",value:function(e,t,n,s){g.fillUsers(e).done(function(e){s&&(0==e.users.length?e.checked="false":"true"==e.checked?(e.groups.length>0&&(e.groups[0].checked=!0,e.groups.slice(1).forEach(function(e){return e.checked=!1})),e.users.forEach(function(e){return e.checked=!0}),e.users.forEach(function(e){return e.hidden=!1})):"false"==e.checked&&(e.groups.forEach(function(e){return e.checked=!1}),e.users.forEach(function(e){return e.checked=e.hidden=!1}))),this.setState({clazz:e})}.bind(this))}},{key:"handleSelectClass",value:function(e,t,n){n.stopPropagation(),"half"==e.checked||"false"==e.checked?e.checked="true":e.checked="false",this.handleClickClass(e,t,n,!0)}},{key:"handleSelectGroup",value:function(e,t){e.checked=!e.checked;var n=this.state.clazz;if(0===e.groupId)e.checked?(n.groups.slice(1).forEach(function(e){return e.checked=!1}),n.users.forEach(function(e){return e.checked=!0})):n.users.forEach(function(e){return e.checked=!1}),n.users.forEach(function(e){return e.hidden=!1});else if(e.checked){var s={};n.groups[0].checked=!1,e.userIds.forEach(function(e){return s[e]=!0});var a=0===n.groups.filter(function(t){return t.groupId!=e.groupId&&t.checked}).length;a?n.users.forEach(function(e){var t=s[e.userId];e.checked=t,e.hidden=!t}):n.users.forEach(function(e){s[e.userId]&&(e.checked=!0,e.hidden=!1)})}else if(n.groups.some(function(e){return e.checked})){var s={};e.userIds.forEach(function(e){return s[e]=!0}),n.groups.slice(1).filter(function(e){return e.checked}).forEach(function(e){e.userIds.forEach(function(e){delete s[e]})}),n.users.forEach(function(e){s[e.userId]&&(e.checked=!1,e.hidden=!0)})}else n.users.forEach(function(e){e.checked=e.hidden=!1});this.syncClassCheckStatus(n),this.setState({clazz:n})}},{key:"handleSelectUser",value:function(e,t){var n=this.state.clazz;e.checked=!e.checked,this.syncClassCheckStatus(n),this.setState({clazz:this.state.clazz})}},{key:"syncClassCheckStatus",value:function(e){e.users.every(function(e){return 1==e.checked})?e.checked="true":e.users.every(function(e){return 1!=e.checked})?e.checked="false":e.checked="half"}},{key:"handleSplitGroup",value:function(t){t.stopPropagation(),e().done(function(e){if(e){var t=this.state.clazz;this.props.onReloadClass(t.classId)}}.bind(this))}},{key:"componentDidUpdate",value:function(){var e=this.refs,t=e.groups;e.users.style.paddingTop=t.offsetHeight+"px"}},{key:"render",value:function(){var e=this,t=[],n=[],a=0,c=this.state,r=c.keyword,i=c.clazz,l=c.classes;i&&(t=i.users||t,n=i.groups||n,a=i.classId),t=t.filter(function(e){return e.hidden!==!0});var o=["行政班","选修班","分层班","分层班"];return s.createElement("div",{className:"c-assign-single c-assign-single-main"},s.createElement("div",{className:"c-assign-single-body"},s.createElement("div",{className:"c-assign-left"},s.createElement("div",{className:"c-assign-search"},s.createElement("i",{className:"icon-delete",onClick:this.handleDeleteKeyword.bind(this)}),s.createElement("lable",{className:"title"},"班级："),s.createElement("input",{type:"text",ref:"keyword",placeholder:"请输入班级名称",value:r,onChange:this.handleChangeKeyword.bind(e)})),s.createElement(k,{className:"c-assign-single-classes"},s.createElement("ul",{className:"c-assign-class-container"},l.filter(function(e){return""==r||"false"!=e.checked||("【"+o[e.classType-1]+"】"+e.className).indexOf(r)>=0}).map(function(t,n){return s.createElement("li",{className:u("c-assign-single-class",{"c-assign-single-checked":t.classId==a}),key:t.classId,onClick:e.handleClickClass.bind(e,t,n)},s.createElement(v,{checked:t.checked,onChange:e.handleSelectClass.bind(e,t,n)}),s.createElement("span",{className:"c-assign-single-name",title:t.className},s.createElement("span",{className:"class-type"},"【",o[t.classType-1],"】"),s.createElement("span",null,t.className)))})))),s.createElement(k,{className:"c-assign-single-stu"},s.createElement("div",{className:"c-detail-container"},s.createElement("div",{ref:"groups",className:"groups"},n.map(function(t,n){return s.createElement("span",{key:t.groupId,className:"item",title:t.groupName,onClick:e.handleSelectGroup.bind(e,t,n)},s.createElement(v,{checked:t.checked}),s.createElement("span",{style:{paddingLeft:4}},t.groupName))}),!i||0!=n.length||1!=i.classType&&4!=i.classType?null:s.createElement("a",{className:"get-groups",onClick:this.handleSplitGroup.bind(e),target:"_blank",href:Leke.domain.lessonServerName+"/auth/teacher/layering/list/list.htm?data="+Base64.encode(i.classId)},"班级还没有分组？试试去分组吧！")),s.createElement("div",{ref:"users"},t.map(function(t,n){return s.createElement("span",{key:t.userId,className:"item",title:t.userName,onClick:e.handleSelectUser.bind(e,t,n)},s.createElement(v,{checked:t.checked}),s.createElement("span",{style:{paddingLeft:4}},t.userName))}),null!=i&&0==t.length?s.createElement("div",{className:"m-tips"},s.createElement("i",null),s.createElement("span",null,"该班级没有学生，请核实后再布置")):null),null==i?s.createElement("div",{className:"m-tips"},s.createElement("i",null),s.createElement("span",null,"请在左侧选择布置的班级")):null))))}}]),n}(s.Component),b=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=this.props,t=e.section,n=e.onReloadClass,a=e.showRemove,c=e.onRemove;return s.createElement("div",{className:"m-assgin-box"},s.createElement("div",{className:"c-assign-h3"},s.createElement("h3",null,"选择作业")),s.createElement(C,{section:t,showRemove:a,onRemove:c}),s.createElement("div",{className:"c-assign-h3"},s.createElement("h3",null,"选择学生")),s.createElement(E,{section:t,onReloadClass:n}))}}]),t}(s.Component),N=1001,_=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={isOpenAnswer:!1,openAnswerTime:"",startTime:d.format(Leke.Clock.time(),"yyyy-MM-dd HH:mm"),closeTime:d.of(Leke.Clock.time()).add(2,"d").format("yyyy-MM-dd HH:mm"),sections:[{key:N++,resources:resources||[]}],pending:!1},n.handleAddSection=n.handleAddSection.bind(n),n.handleReloadClass=n.handleReloadClass.bind(n),n.handleSaveAssign=n.handleSaveAssign.bind(n),n.handleChangeOpenAnswer=n.handleChangeOpenAnswer.bind(n),n.handleChangeStartTime=n.handleChangeStartTime.bind(n),n.handleChangeCloseTime=n.handleChangeCloseTime.bind(n),n.handleChangeOpenAnswerTime=n.handleChangeOpenAnswerTime.bind(n),n}return _inherits(t,e),_createClass(t,[{key:"handleChangeOpenAnswer",value:function(){var e=this.state,t=e.isOpenAnswer,n=(e.openAnswerTime,e.closeTime);t?this.setState({isOpenAnswer:!1,openAnswerTime:""}):this.setState({isOpenAnswer:!0,openAnswerTime:d.of(n).add(2,"d").format("yyyy-MM-dd HH:mm")})}},{key:"handleChangeOpenAnswerTime",value:function(e){this.setState({openAnswerTime:e})}},{key:"handleChangeStartTime",value:function(e){this.setState({startTime:e})}},{key:"handleChangeCloseTime",value:function(e){this.setState({closeTime:e})}},{key:"handleAddSection",value:function(){var e=this.state.sections;e.push({id:N++,resources:[]}),this.setState({sections:e})}},{key:"handleDelSection",value:function(e){if(this.state.sections.length<=1)return void i.Notice.alert("最后一个啦");var t=c.grep(this.state.sections,function(t,n){return t.id!=e});this.setState({sections:t})}},{key:"handleReloadClass",value:function(e){g.fetchUsers(e,!0).done(function(t){var n=this.state.sections;n.forEach(function(n){n.clazz=null,n.classes.filter(function(t){return t.classId==e}).forEach(function(e){e.checked="false",e.users=g.clone(t.users),e.groups=g.clone(t.groups)})}),this.setState({sections:n})}.bind(this))}},{key:"handleSaveAssign",value:function(){for(var e=this.state,t=e.startTime,n=e.closeTime,s=e.isOpenAnswer,a=e.openAnswerTime,l=this.state.sections.map(function(e){return{resources:e.resources,classes:e.classes.filter(function(e){return"false"!==e.checked}).map(function(e){var t={classId:e.classId,className:e.className,classType:e.classType};return t.groups=e.groups.filter(function(e){return e.checked&&0!==e.groupId}).map(function(e){return{groupId:e.groupId,groupName:e.groupName}}),t.users=e.users.filter(function(e){return!e.hidden&&e.checked}).map(function(e){return{userId:e.userId,userName:e.userName}}),t})}}),o=0;o<l.length;o++){var u=l[o];if(0==u.resources.length)return void i.Notice.alert("第"+(o+1)+"条作业未选择");if(0==u.classes.length)return void i.Notice.alert("第"+(o+1)+"条班级未选择")}if(""==t)return void i.Notice.alert("请设置作业开始时间");if(""==n)return void i.Notice.alert("请设置作业截止时间");if(s&&""==a)return void i.Notice.alert("请设置公布答案时间");var h={startTime:d.parse(t,"yyyy-MM-dd HH:mm").getTime(),closeTime:d.parse(n,"yyyy-MM-dd HH:mm").getTime(),sections:l};""!=a&&(h.openAnswerTime=d.parse(a,"yyyy-MM-dd HH:mm").getTime()),this.setState({pending:!0}),c.post("saveAssign.htm",{dataJson:r.stringify(h)}).done(function(e){if(e.success){var t="success.htm";e.datas.homeworkId&&(t+="?homeworkId="+e.datas.homeworkId),window.location.href=t}else this.setState({pending:!1})}.bind(this))}},{key:"render",value:function(){var e=this,t=this,n=this.state.sections.length>1;u("u-btn u-btn-lg",this.state.pending?"u-btn-bg-gray":"u-btn-bg-turquoise");return s.createElement("div",null,this.state.sections.map(function(a,c){return s.createElement(b,{key:a.id+"",section:a,onReloadClass:e.handleReloadClass,showRemove:n,onRemove:t.handleDelSection.bind(t,a.id)})}),s.createElement("div",{className:"c-assign-h3"},s.createElement("h3",null,"选择时间")),s.createElement("div",{className:"c-assign-date z-clear c-assign-bottom-date"},s.createElement("div",{className:"c-assign-picker"},s.createElement("p",{className:"z-tips"},"作业开始时间："),s.createElement(y,{id:"startTime",className:"u-ipt u-ipt-nm c-assign-date-container",setting:{dateFmt:"yyyy-MM-dd HH:mm",maxDate:"#F{$dp.$D('closeTime');}"},placeholder:"作业开始时间",defaultValue:this.state.startTime,onChange:this.handleChangeStartTime})),s.createElement("span",{className:"c-assign-line"}),s.createElement("div",{className:"c-assign-picker"},s.createElement("p",{className:"z-tips"},"作业截止时间："),s.createElement(y,{id:"closeTime",className:"u-ipt u-ipt-nm c-assign-date-container",setting:{dateFmt:"yyyy-MM-dd HH:mm",minDate:"#F{$dp.$D('startTime');}"},placeholder:"作业截止时间",defaultValue:this.state.closeTime,onChange:this.handleChangeCloseTime})),s.createElement("div",{className:"c-assign-picker c-assign-publish-picker"},s.createElement(v,{checked:this.state.isOpenAnswer,onChange:this.handleChangeOpenAnswer}),s.createElement("span",{className:"z-inline-zips"},s.createElement("span",{onClick:this.handleChangeOpenAnswer},"设置公布答案时间")),this.state.isOpenAnswer?s.createElement(y,{id:"openAnswerTime",className:"u-ipt u-ipt-nm c-assign-date-container",setting:{dateFmt:"yyyy-MM-dd HH:mm"},placeholder:"公布答案时间",defaultValue:this.state.openAnswerTime,onChange:this.handleChangeOpenAnswerTime}):null,s.createElement("p",{className:"z-tips"}))),s.createElement("div",{className:"c-assign-plus m-tiptext m-tiptext-text m-tiptext-warning"},s.createElement("i",{className:"iconfont icon"},"󰅂 "),s.createElement("span",null,"小乐提醒您：如果您想给不同层次的学生布置不同的作业，可以点击“",s.createElement("a",{className:"c-assign-plus-btn",onClick:this.handleAddSection},"+增加作业"),"”试试。")),s.createElement("div",{className:"c-quick-btns"},s.createElement("ul",null,s.createElement("li",{className:"btn",onClick:this.handleAddSection},"增加作业"),s.createElement("li",{className:"btn",onClick:this.handleSaveAssign,disabled:this.state.pending},"确定布置"))))}}]),t}(s.Component);a.render(s.createElement(_,null),document.getElementById("container"))});