"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();define(function(require,exports,module){function e(e,t,n){var a=e[t];e[t]=function(){s.isFunction(a)&&a(),n()}}var t=require("common/react/react"),n=require("common/react/react-dom"),s=require("jquery"),a=require("json"),c=require("utils"),r=require("dialog"),i=require("common/react/react-utils"),l=i.cx,o=require("common/base/date"),u=require("common/ui/ui-datepicker/ui-datepicker");require("common/ui/ui-scrollbar/jquery.scrollbar.min");var h={userMap:{},clone:function(e){return s.isArray(e)?e.map(function(e){return s.extend(!0,{},e)}):s.extend(!0,{},e)},getClasses:function(){var e=h.clone(classes);return e.forEach(function(e){return e.checked="false"}),e},fillUsers:function(e){var t=e.classId,n=s.Deferred();return null!=e.users?n.resolve(e):h[t]?(e.users=h[t].users,e.groups=h[t].groups,n.resolve(e)):s.post("users.htm",{classId:t}).done(function(t){var s=t.datas.users,a=t.datas.groups;if(a.length>0){var c=s.map(function(e){return e.userId});a.forEach(function(e){return e.checked=!1}),a.unshift({groupId:0,groupName:"全班",checked:!1,userIds:c})}s.sort(function(e,t){return e.pinyin>t.pinyin?1:e.pinyin<t.pinyin?-1:0}),s.forEach(function(e){return e.checked=e.hidden=!1}),e.users=h.clone(s),e.groups=h.clone(a),n.resolve(e)}),n}},d=function(e){function n(){return _classCallCheck(this,n),_possibleConstructorReturn(this,Object.getPrototypeOf(n).apply(this,arguments))}return _inherits(n,e),_createClass(n,[{key:"componentDidMount",value:function(){s(this.refs.scroll).scrollbar()}},{key:"render",value:function(){var e="scrollbar-inner "+this.props.className;return t.createElement("div",{ref:"scroll",className:e},this.props.children)}}]),n}(t.Component),p=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,e));return t.state={checked:e.checked||!1},t}return _inherits(n,e),_createClass(n,[{key:"componentWillReceiveProps",value:function(e){this.props.checked!=e.checked&&this.setState({checked:e.checked})}},{key:"handleClick",value:function(e){this.props.onChange&&this.props.onChange(e)}},{key:"render",value:function(){var e=this.state.checked,n="c-assign-single-checkbox c-assign-single-checkbox-"+e;return t.createElement("span",{className:n,onClick:this.handleClick.bind(this)})}}]),n}(t.Component),m=function(n){function a(e){_classCallCheck(this,a);var t=_possibleConstructorReturn(this,Object.getPrototypeOf(a).call(this,e));return t.handleClick=t.handleClick.bind(t),t.handleChange=t.handleChange.bind(t),t.state={value:e.value,options:t.parseOptions(e.setting)},t}return _inherits(a,n),_createClass(a,[{key:"parseOptions",value:function(t){var n=s.extend({readOnly:!0},t);return e(n,"onpicked",this.handleChange),e(n,"oncleared",this.handleChange),n}},{key:"handleClick",value:function(e){u.open(e.nativeEvent,this.state.options)}},{key:"getValue",value:function(){return this.refs.picket.value}},{key:"handleChange",value:function(){var e=this.refs.picket.value;this.setState({value:e}),this.props.onChange&&this.props.onChange(e)}},{key:"render",value:function(){return t.createElement("input",{ref:"picket",id:this.props.id,type:"text",className:l(this.props.className,"Wdate"),defaultValue:this.props.defaultValue,placeholder:this.props.placeholder,onClick:this.handleClick})}}]),a}(t.Component),f=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,e));return t.state={datas:e.section.papers},t.handleSelect=t.handleSelect.bind(t),t}return _inherits(n,e),_createClass(n,[{key:"handleSelect",value:function(){var e=this,t=this.state.datas.map(function(e){return e.paperId}).join(",");r.open({id:"dPopPapers",size:"lg",title:"选择试卷",url:ctx+"/auth/teacher/distribute/popPapers.htm?paperIds="+t,onClose:function(t){if(t){var n=a.parse(a.stringify(t.list));e.setState({datas:n}),e.props.section.papers=n}}})}},{key:"handleRemove",value:function(e,t){var n=this.state.datas;n.splice(t,1),this.setState({datas:n}),this.props.section.papers=n}},{key:"render",value:function(){var e=this;return t.createElement("div",{className:"c-assign-single-hwc c-assign-single-left"},t.createElement("label",{className:"c-assign-single-lh"},t.createElement("span",null,"选择试卷："),t.createElement("button",{className:"u-btn u-btn-sm u-btn-bg-orange c-assign-single-choose",onClick:this.handleSelect},"请选择")),t.createElement("div",{className:"c-assign-work"},this.state.datas.map(function(n,s){return t.createElement("span",{key:s,className:"c-assign-work-item"},t.createElement("b",{title:n.paperName},n.paperName),t.createElement("i",{onClick:e.handleRemove.bind(e,n,s)},"×"))})))}}]),n}(t.Component),g=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,e));return t.state={classes:h.getClasses(),clazz:null},e.section.classes=t.state.classes,t}return _inherits(n,e),_createClass(n,[{key:"handleClickClass",value:function(e,t,n,s){h.fillUsers(e).done(function(e){s&&(0==e.users.length?e.checked="false":"true"==e.checked?(e.groups.length>0&&(e.groups[0].checked=!0,e.groups.slice(1).forEach(function(e){return e.checked=!1})),e.users.forEach(function(e){return e.checked=!0}),e.users.forEach(function(e){return e.hidden=!1})):"false"==e.checked&&(e.groups.forEach(function(e){return e.checked=!1}),e.users.forEach(function(e){return e.checked=e.hidden=!1}))),this.setState({clazz:e})}.bind(this))}},{key:"handleSelectClass",value:function(e,t,n){n.stopPropagation(),"half"==e.checked||"false"==e.checked?e.checked="true":e.checked="false",this.handleClickClass(e,t,n,!0)}},{key:"handleSelectGroup",value:function(e,t){e.checked=!e.checked;var n=this.state.clazz;if(0===e.groupId)e.checked?(n.groups.slice(1).forEach(function(e){return e.checked=!1}),n.users.forEach(function(e){return e.checked=!0})):n.users.forEach(function(e){return e.checked=!1}),n.users.forEach(function(e){return e.hidden=!1});else if(e.checked){var s={};n.groups[0].checked=!1,e.userIds.forEach(function(e){return s[e]=!0});var a=0===n.groups.filter(function(t){return t.groupId!=e.groupId&&t.checked}).length;a?n.users.forEach(function(e){var t=s[e.userId];e.checked=t,e.hidden=!t}):n.users.forEach(function(e){s[e.userId]&&(e.checked=!0,e.hidden=!1)})}else if(n.groups.some(function(e){return e.checked})){var s={};e.userIds.forEach(function(e){return s[e]=!0}),n.groups.slice(1).filter(function(e){return e.checked}).forEach(function(e){e.userIds.forEach(function(e){delete s[e]})}),n.users.forEach(function(e){s[e.userId]&&(e.checked=!1,e.hidden=!0)})}else n.users.forEach(function(e){e.checked=e.hidden=!1});this.syncClassCheckStatus(n),this.setState({clazz:n})}},{key:"handleSelectUser",value:function(e,t){var n=this.state.clazz;e.checked=!e.checked,this.syncClassCheckStatus(n),this.setState({clazz:this.state.clazz})}},{key:"syncClassCheckStatus",value:function(e){e.users.every(function(e){return 1==e.checked})?e.checked="true":e.users.every(function(e){return 1!=e.checked})?e.checked="false":e.checked="half"}},{key:"componentDidUpdate",value:function(){var e=this.refs,t=e.groups,n=e.users;n.style.paddingTop=t.offsetHeight+"px"}},{key:"render",value:function(){var e=this,n=[],s=[],a=0;this.state.clazz&&(n=this.state.clazz.users||n,s=this.state.clazz.groups||s,a=this.state.clazz.classId),n=n.filter(function(e){return e.hidden!==!0});var c=["c-assign-xing-icon","c-assign-xuan-icon","c-assign-fen-icon","c-assign-fen-icon"];return t.createElement("div",{className:"c-assign-single-body"},t.createElement(d,{className:"c-assign-single-classes"},t.createElement("ul",{className:"c-assign-class-container"},this.state.classes.map(function(n,s){return t.createElement("li",{className:l("c-assign-single-class",{"c-assign-single-checked":n.classId==a}),key:n.classId,onClick:e.handleClickClass.bind(e,n,s)},t.createElement(p,{checked:n.checked,onChange:e.handleSelectClass.bind(e,n,s)}),t.createElement("span",{className:c[n.classType-1]}),t.createElement("span",{className:"c-assign-single-name",title:n.className},n.className))}))),t.createElement(d,{className:"c-assign-single-stu"},t.createElement("div",{className:"c-detail-container"},t.createElement("div",{ref:"groups",className:"groups"},s.map(function(n,s){return t.createElement("span",{key:n.groupId,className:"item",title:n.groupName,onClick:e.handleSelectGroup.bind(e,n,s)},t.createElement(p,{checked:n.checked}),t.createElement("span",{style:{paddingLeft:4}},n.groupName))})),t.createElement("div",{ref:"users"},n.map(function(n,s){return t.createElement("span",{key:n.userId,className:"item",title:n.userName,onClick:e.handleSelectUser.bind(e,n,s)},t.createElement(p,{checked:n.checked}),t.createElement("span",{style:{paddingLeft:4}},n.userName))}),null!=e.state.clazz&&0==n.length?t.createElement("div",{className:"m-tips"},t.createElement("i",null),t.createElement("span",null,"该班级没有学生，请核实后再布置")):null),null==e.state.clazz?t.createElement("div",{className:"m-tips"},t.createElement("i",null),t.createElement("span",null,"请在左侧选择布置的班级")):null)))}}]),n}(t.Component),k=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,e));return t.handleRemove=t.handleRemove.bind(t),t}return _inherits(n,e),_createClass(n,[{key:"handleRemove",value:function(){this.props.onRemove&&this.props.onRemove()}},{key:"render",value:function(){return t.createElement("div",{className:"c-assign-single"},t.createElement("div",{className:"c-assign-single-header"},t.createElement(f,{section:this.props.section}),t.createElement("div",{className:"c-assign-single-sc c-assign-single-left"},"选择学生："),t.createElement("span",{className:"c-assign-single-delete",onClick:this.handleRemove})),t.createElement(g,{section:this.props.section}))}}]),n}(t.Component),v=1001,y=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,e));return t.state={startTime:o.format(Leke.Clock.time(),"yyyy-MM-dd HH:mm"),closeTime:"",sections:[{key:v++,papers:papers||[]}],pending:!1},t.handleAddSection=t.handleAddSection.bind(t),t.handleSaveAssign=t.handleSaveAssign.bind(t),t.handleChangeStartTime=t.handleChangeStartTime.bind(t),t.handleChangeCloseTime=t.handleChangeCloseTime.bind(t),t}return _inherits(n,e),_createClass(n,[{key:"handleChangeStartTime",value:function(e){this.setState({startTime:e})}},{key:"handleChangeCloseTime",value:function(e){this.setState({closeTime:e})}},{key:"handleAddSection",value:function(){var e=this.state.sections;e.push({id:v++,papers:[]}),this.setState({sections:e})}},{key:"handleDelSection",value:function(e){if(this.state.sections.length<=1)return void c.Notice.alert("最后一个啦");var t=s.grep(this.state.sections,function(t,n){return t.id!=e});this.setState({sections:t})}},{key:"handleSaveAssign",value:function(){var e=this.state,t=e.startTime,n=e.closeTime;if(""==t)return void c.Notice.alert("请选择作业开始时间");if(""==n)return void c.Notice.alert("请选择作业截止时间");for(var r=this.state.sections.map(function(e){return{paperIds:e.papers.map(function(e){return e.paperId}),classes:e.classes.filter(function(e){return"false"!==e.checked}).map(function(e){var t={classId:e.classId,className:e.className,classType:e.classType};return t.groups=e.groups.filter(function(e){return e.checked&&0!==e.groupId}).map(function(e){return{groupId:e.groupId,groupName:e.groupName}}),t.users=e.users.filter(function(e){return!e.hidden&&e.checked}).map(function(e){return{userId:e.userId,userName:e.userName}}),t})}}),i=0;i<r.length;i++){var l=r[i];if(0==l.paperIds.length)return void c.Notice.alert("第"+(i+1)+"条试卷未选择");if(0==l.classes.length)return void c.Notice.alert("第"+(i+1)+"条班级未选择")}var u={startTime:o.parse(t,"yyyy-MM-dd HH:mm").getTime(),closeTime:o.parse(n,"yyyy-MM-dd HH:mm").getTime(),sections:r};this.setState({pending:!0}),s.post("saveAssign.htm",{dataJson:a.stringify(u)}).done(function(e){if(e.success){var t="success.htm";e.datas.homeworkId&&(t+="?homeworkId="+e.datas.homeworkId),window.location.href=t}else this.setState({pending:!1})}.bind(this))}},{key:"render",value:function(){var e=this,n=l("u-btn u-btn-lg",this.state.pending?"u-btn-bg-gray":"u-btn-bg-turquoise");return t.createElement("div",null,t.createElement("div",{className:"c-assign-header"},"布置作业"),this.state.sections.map(function(n,s){return t.createElement(k,{key:n.id+"",section:n,onRemove:e.handleDelSection.bind(e,n.id)})}),t.createElement("div",{className:"c-assign-date z-clear"},t.createElement("div",{className:"c-assign-picker"},t.createElement(m,{id:"startTime",className:"u-ipt u-ipt-nm c-assign-date-container",setting:{dateFmt:"yyyy-MM-dd HH:mm",maxDate:"#F{$dp.$D('closeTime');}"},placeholder:"作业开始时间",defaultValue:this.state.startTime,onChange:this.handleChangeStartTime}),t.createElement("p",{className:"z-tips"},"作业开始时间")),t.createElement("span",{className:"c-assign-line"}),t.createElement("div",{className:"c-assign-picker"},t.createElement(m,{id:"closeTime",className:"u-ipt u-ipt-nm c-assign-date-container",setting:{dateFmt:"yyyy-MM-dd HH:mm",minDate:"#F{$dp.$D('startTime');}"},placeholder:"作业截止时间",onChange:this.handleChangeCloseTime}),t.createElement("p",{className:"z-tips"},"作业截止时间"))),t.createElement("div",{className:"c-assign-plus m-tiptext m-tiptext-text m-tiptext-warning"},t.createElement("i",{className:"iconfont icon"},"󰅂 "),t.createElement("span",null,"小乐提醒您：如果您想给不同层次的学生布置不同的作业，可以点击“+增加作业”试试。"),t.createElement("a",{className:"c-assign-plus-btn",onClick:this.handleAddSection},"+增加作业")),t.createElement("div",{className:"z-sub-btn"},t.createElement("button",{className:n,onClick:this.handleSaveAssign,disabled:this.state.pending},this.state.pending?"处理中...":"布置")))}}]),n}(t.Component);n.render(t.createElement(y,null),document.getElementById("container"))});